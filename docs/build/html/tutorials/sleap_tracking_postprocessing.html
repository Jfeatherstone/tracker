<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Loading data" href="loading_data.html" /><link rel="prev" title="SLEAP training" href="sleap_training.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>SLEAP tracking and postprocessing - tracker 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_collapse.css?v=226d88b4" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/overrides.css?v=e9ec496f" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">tracker 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">tracker 0.1.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../tutorials_top.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="environment_setup.html">Setup your environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="sleap_training.html">SLEAP training</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">SLEAP tracking and postprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_data.html">Loading data</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../autoapi/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../autoapi/tracker/index.html">tracker</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of tracker</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/analysis/index.html">tracker.analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/discretize/index.html">tracker.discretize</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/discretize_old/index.html">tracker.discretize_old</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/load_data/index.html">tracker.load_data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/sleap_postprocess/index.html">tracker.sleap_postprocess</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autoapi/tracker/utils/index.html">tracker.utils</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorials/sleap_tracking_postprocessing.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          
<style>
  .ss-layout-default-A_B { grid-template-areas: 'A' 'B'; }
</style>
<section id="sleap-tracking-and-postprocessing">
<h1>SLEAP tracking and postprocessing<a class="headerlink" href="#sleap-tracking-and-postprocessing" title="Link to this heading">¶</a></h1>
<p>This tutorial covers the tracking and post-processing workflow for the
data in the publication. Unless you are working with your own data, you
probably won’t need to follow any of the steps here, as the final post-processed
data is available to download (to be used in the rest of the tutorials).</p>
<p>Excepting the tracking done with SLEAP, all of the code that implements
these steps can be found in the notebook <code class="docutils literal notranslate"><span class="pre">00_PreprocessData.ipynb</span></code>.</p>
<section id="sleap-tracking">
<h2>SLEAP tracking<a class="headerlink" href="#sleap-tracking" title="Link to this heading">¶</a></h2>
<p>Tracking the videos with SLEAP is relatively easy, though since there is
quite a large amount (~100), I created a script to do this on my institute’s
cluster.</p>
<div class="sphinx_collapse docutils container">
<input class="sphinx_collapse__input" id="d20cbb69-e3b8-42d7-b5e9-d91756675818" name="d20cbb69-e3b8-42d7-b5e9-d91756675818" type="checkbox"><label class="sphinx_collapse__label" for="d20cbb69-e3b8-42d7-b5e9-d91756675818"><i class="sphinx_collapse__icon"></i>Click here for the script.</label><div class="sphinx_collapse__content docutils container">
<p>This script was written for the <code class="docutils literal notranslate"><span class="pre">slurm</span></code> job scheduler, though it
can also just be run as a bash script. Ideally it should be run
on a computer with a GPU.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH -p gpu</span>
<span class="c1">#SBATCH -t 72:00:00</span>
<span class="c1">#SBATCH --mem=64G</span>
<span class="c1">#SBATCH --gres=gpu:1</span>
<span class="c1">#SBATCH --job-name=SLEAP-Track</span>

<span class="c1">##############################################</span>
<span class="c1"># Script to run a sleap training job</span>
<span class="c1">#</span>
<span class="c1"># The first argument should be a partial match to the</span>
<span class="c1"># model file name. We use a partial match so that if</span>
<span class="c1"># we have a two part model (centroid and centered instance)</span>
<span class="c1"># we can match both with the same partial string.</span>
<span class="c1">#</span>
<span class="c1"># The following argument(s) should be the path to the video(s).</span>
<span class="c1">#</span>
<span class="c1"># eg. using slurm:</span>
<span class="c1"># sbatch track.slurm model_name_partial /path/to/video1 /path/to/video2 ...</span>
<span class="c1">#</span>
<span class="c1"># eg. as a bash script:</span>
<span class="c1"># ./track.slurm model_name_partial /path/to/video1 /path/to/video2 ...</span>
<span class="c1">#</span>
<span class="c1"># Note that this will likely not work if you try</span>
<span class="c1"># to resume training from a previous checkpoint,</span>
<span class="c1"># since it won&#39;t be able to find the previous</span>
<span class="c1"># model files.</span>
<span class="c1">##############################################</span>

<span class="c1">##############################################</span>
<span class="c1"># Parameters</span>
<span class="c1">##############################################</span>

<span class="c1"># Will copy the trajectories over to the following location after finishing</span>
<span class="c1"># Can be a remote location, eg: &quot;external:/path/to/output/&quot;</span>
<span class="nv">outputDir</span><span class="o">=</span><span class="s2">&quot;/path/to/output/&quot;</span>

<span class="c1"># The directory where sleap should search for models</span>
<span class="nv">modelsDir</span><span class="o">=</span><span class="s2">&quot;/path/to/models/&quot;</span>

<span class="c1"># Somewhere to create a temporary folder. If you have a work partition</span>
<span class="c1"># on a cluster or something, this should point there. ie. some place that</span>
<span class="c1"># you have read/write permissions.</span>
<span class="nv">tempLocation</span><span class="o">=</span><span class="s2">&quot;/path/to/temp/&quot;</span>

<span class="c1"># The name of your conda environment that has sleap</span>
<span class="nv">sleapEnv</span><span class="o">=</span><span class="s2">&quot;sleap&quot;</span>

<span class="c1"># If you need to source a file (eg. .bashrc, .zshrc) in order to</span>
<span class="c1"># load conda, you can do that here.</span>
<span class="nb">source</span><span class="w"> </span>/path/to/your/source_file<span class="w">  </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="c1">##############################################</span>
<span class="c1"># End parameters</span>
<span class="c1">##############################################</span>

<span class="c1"># First, search for the full model path</span>
<span class="c1"># We pass as an argument the partial name of the model,</span>
<span class="c1"># since if we are doing multi-animal, we might have</span>
<span class="c1"># more than one model.</span>
<span class="nv">modelFiles</span><span class="o">=</span><span class="sb">`</span>find<span class="w"> </span><span class="nv">$modelsDir</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*</span><span class="nv">$1</span><span class="s2">*&quot;</span><span class="w"> </span>-print<span class="sb">`</span>

<span class="nv">modelArgs</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for</span><span class="w"> </span>modelName<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$modelFiles</span><span class="p">;</span>
<span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Using model: </span><span class="nv">$modelName</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">modelArgs</span><span class="o">+=</span><span class="s2">&quot;-m </span><span class="nv">$modelName</span><span class="s2"> &quot;</span>
<span class="k">done</span>

<span class="c1"># Make sure we found something</span>
<span class="c1"># Check that the length of the string is zero</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="si">${#</span><span class="nv">modelArgs</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Invalid model name provided! No models found in </span><span class="nv">$modelsDir</span><span class="s2"> that match partial string \&quot;</span><span class="nv">$1</span><span class="s2">\&quot;&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Make sure the video file(s) exist</span>
<span class="c1"># Remove the first argument, since that was the model name</span>
<span class="nb">shift</span>
<span class="k">for</span><span class="w"> </span>video<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="nv">$video</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Video does not exist: </span><span class="nv">$video</span><span class="s2">&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Running tracking on videos:&quot;</span>
<span class="k">for</span><span class="w"> </span>video<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;       </span><span class="nv">$video</span><span class="s2">&quot;</span>
<span class="k">done</span>


<span class="c1"># Create a temporary directory for this job and save the name</span>
<span class="nv">tempdir</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">tempLocation</span><span class="si">}</span><span class="s2">/temp.XXXXXX&quot;</span><span class="k">)</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Created temporary directory: </span><span class="nv">$tempdir</span><span class="s2">&quot;</span>

<span class="c1"># Enter the temporary directory</span>
<span class="nb">cd</span><span class="w"> </span><span class="nv">$tempdir</span>

<span class="c1"># Activate your sleap conda environment</span>
conda<span class="w"> </span>activate<span class="w"> </span><span class="nv">$sleapEnv</span>

<span class="c1"># Now loop over each video and perform the tracking</span>
<span class="k">for</span><span class="w"> </span>videoPath<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Tracking video: </span><span class="nv">$videoPath</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Remove the path</span>
<span class="w">    </span><span class="nv">outputPath</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$videoPath</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="c1"># Remove the extension</span>
<span class="w">    </span><span class="nv">outputPath</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">outputPath</span><span class="p">%.*</span><span class="si">}</span><span class="s2">_tracked&quot;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Output file: </span><span class="nv">$outputPath</span><span class="s2">&quot;</span>

<span class="w">    </span>sleap-track<span class="w"> </span><span class="nv">$videoPath</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">$outputPath</span><span class="w"> </span><span class="nv">$modelArgs</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--video.dataset<span class="w"> </span>video<span class="w"> </span>--video.input_format<span class="w"> </span>channels_last<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>--tracking.tracker<span class="w"> </span>simple<span class="w"> </span>--tracking.similarity<span class="w"> </span>centroid

<span class="w">    </span><span class="c1"># Note that sleap will automatically add a &quot;.slp&quot; to the</span>
<span class="w">    </span><span class="c1"># output name, so we need to add that here.</span>
<span class="w">    </span><span class="nv">trueOutputPath</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">outputPath</span><span class="si">}</span><span class="s2">.slp&quot;</span>

<span class="w">    </span><span class="c1"># Copy our result back to the output. We use &quot;scp&quot; to copy the data</span>
<span class="w">    </span><span class="c1"># back as we may have a remote server.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-f<span class="w"> </span><span class="nv">$trueOutputPath</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Copying file: </span><span class="nv">$trueOutputPath</span><span class="s2">&quot;</span>
<span class="w">        </span>scp<span class="w"> </span><span class="nv">$trueOutputPath</span><span class="w"> </span><span class="nv">$outputDir</span>/
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>

<span class="c1"># Clean up by removing our temporary directory</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Cleaning up temporary directory&quot;</span>
rm<span class="w"> </span>-r<span class="w"> </span><span class="nv">$tempdir</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Done!&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>I made several changes to this script to make it more general when
copying it here, so if it doesn’t work exactly as written, sorry…
But you should only have to make some small corrections (hopefully).</p>
</div>
</div>
</div>
<p>After running the tracking, you should have a <code class="docutils literal notranslate"><span class="pre">.slp</span></code> file for each video
tracked, which includes the tracks detected in each video. Note that the
script above only using the centroid tracker (tracker in the sense of identifying
posture detections through time as the same ant). This means that for each
video, we actually have a very large amount of “individual” ants.</p>
<figure class="align-default" id="id1">
<img alt="../_images/initial_tracks.png" src="../_images/initial_tracks.png" />
<figcaption>
<p><span class="caption-text">The number of identified ants in a single video. These are of course all
the same ant.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>So one of the first things we need to do is to clean up these tracks, and give
a consistent identity across the whole video. This isn’t as easy as just
assigning each position to the same identity, since there sometimes are spurious
identifications (see the horizontal lines in the image above). Maybe there is
a way to just better calibrate SLEAP’s tracker, but I just ended up using
a custom one, which factors in the distance from previous positions, as well
as the score of the detection to connect the trajectories.</p>
<p>For more information, see <code class="xref py py-meth docutils literal notranslate"><span class="pre">tracker.trackSleapFile()</span></code>.</p>
</section>
<section id="identifying-segments">
<h2>Identifying segments<a class="headerlink" href="#identifying-segments" title="Link to this heading">¶</a></h2>
<p>While the tracker helps to make the posture instances more continuous through
time, there are inevitably going to be gaps in the trajectories. These can be
caused by small tracking errors or failures, but also by the ant leaving the
field of view of the camera (possible because the ants can climb the walls).
To deal with these gaps in a consistent way, we set a maximum limit to how
much we (linearly) interpolate missing data points. I typically use 30 frames
(0.5s for 60Hz) throughout the analysis unless specified otherwise. When we
have a gap larger than this amount, we separate the trajectory before and
after into different “segments”, meaning a single experiment can have
potentially many trajectories. We generally see that, for each experiment,
there will be a few longer segments, and then many shorter ones comprising
short bouts of motion.</p>
<figure class="sphinx-subfigure align-default" id="id2">
<div class="sphinx-subfigure-grid ss-layout-default-A_B" style="display: grid;">
<div class="sphinx-subfigure-area" style="display: flex; flex-direction: column; justify-content: center; align-items: center; grid-area: A;">
<img alt="../_images/segment_lengths.png" src="../_images/segment_lengths.png" />
</div>
<div class="sphinx-subfigure-area" style="display: flex; flex-direction: column; justify-content: center; align-items: center; grid-area: B;">
<img alt="../_images/jump_sizes.png" src="../_images/jump_sizes.png" />
</div>
</div>
<figcaption>
<p><span class="caption-text">Histograms of the duration of each segment for ant trajectories (left)
and the largest interpolated jump in each segment (right).</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Next, we observe that there are a few segments that give tracking data outside
of the enclosure; this could be due to spurious detections, or could be
from tracker the ant as it enters the enclosure. Either way, we want to
remove them, so we remove points beyond the manually-defined bounds of
the arena.</p>
<figure class="align-default" id="id3">
<img alt="../_images/overlay.png" src="../_images/overlay.png" />
<figcaption>
<p><span class="caption-text">All trajectories overlaid; some show detections outside of the arena.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="attaching-metadata-and-cleaning-up">
<h2>Attaching metadata and cleaning up<a class="headerlink" href="#attaching-metadata-and-cleaning-up" title="Link to this heading">¶</a></h2>
<p>At this point, we have all of our segments identified, so we just need to
package the data in a way that is easy to analyze later. I decided to use
the <a class="reference external" href="https://en.wikipedia.org/wiki/Hierarchical_Data_Format">hdf5 format</a>,
since it allows the metadata to be kept alongside each segment. This includes
information about the experimental conditions, the SLEAP tracking, and the
post-processing.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="loading_data.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Loading data</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="sleap_training.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">SLEAP training</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2026, Jack Featherstone
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">SLEAP tracking and postprocessing</a><ul>
<li><a class="reference internal" href="#sleap-tracking">SLEAP tracking</a></li>
<li><a class="reference internal" href="#identifying-segments">Identifying segments</a></li>
<li><a class="reference internal" href="#attaching-metadata-and-cleaning-up">Attaching metadata and cleaning up</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=01f34227"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>